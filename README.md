# CSVParser
CSVParser – консольное приложение для потокового вычисления скользящей медианы цен (price) из CSV-файлов биржевых данных. Программа считывает временные метки receive_ts и цены, рассчитывает медиану по мере поступления данных и сохраняет результат в выходной CSV-файл только в те моменты, когда медиана изменяется больше заданного порога (eps = 1e-8). 

Программа автоматически выбирает одну из двух стратегий обработки в зависимости от доступного объёма памяти.

## In-memory режим

Если общий объём всех считанных данных (структуры receive_ts и price) не превышает max-memory/max-thread, все данные загружаются в оперативную память, сортируются по времени, и скользящая медиана вычисляется с использованием двух куч (max-heap / min-heap).

## File-based режим

Если данные не помещаются в память, программа сохраняет отсортированные фрагменты во временные бинарные файлы, затем выполняет многопутевое слияние в один отсортированный файл. После этого медиана вычисляется в два этапа:

Для первых 5 значений используется точная сортировка (чтобы гарантировать корректность начала ряда).

Для всех последующих значений применяется накопительный алгоритм P² из библиотеки Boost.Accumulators, который оценивает медиану с высокой точностью без хранения всей истории.

Выбор стратегии происходит автоматически: если в процессе сбора данных потребовалось создать хотя бы один временный файл, активируется file-based режим.

## Требования

C++20

CMake 3.23+

Зависимости:

* Boost (program_options, accumulators)

* spdlog

* toml++

## Сборка

```bash
mkdir build && cd build && cmake -DBUILD_TESTING=OFF .. && cmake --build .
```

-DBUILD_TESTING=ON - необязательный флаг, по умолчанию для Release сборки OFF

## Запуск

./CSVParser [-опции]

Аргументы командной строки:
 * -h, --help - Показать справку
 * --config arg - Путь к TOML-файлу конфигурации
 * --cfg arg - Альтернативный вариант указания конфига (синоним --config)
 * --max-memory arg - Максимальный размер буфера в памяти (в байтах). По умолчанию 524288000 (500 МБ)
 * --max-thread arg - Количество потоков для парсинга. По умолчанию 4

## Конфигурационный файл

```toml
[main]
input = "./data"                 # директория с входными CSV-файлами
output = "./results"             # директория для выходного файла (будет создана)
filename_mask = [ "AAPL", "MSFT" ]
```
* input – обязательный параметр.
* output – необязательный; по умолчанию ./output.
* filename_mask – массив строк; если задан, обрабатываются только те CSV-файлы, в имени которых встречается хотя бы одна из масок. Если массив пуст или отсутствует, берутся все .csv файлы из input.

# Выходной файл

Результат сохраняется по пути output/output.csv (где output – значение из конфига). Формат файла:

```csv
receive_ts;price_median
1625097600000;123.45678901
1625097601000;123.45678901
```

Первая строка – заголовок.

Временная метка (receive_ts) – целое число (uint64), соответствует времени поступления данных.

Цена (price_median) – вещественное число с фиксированной точностью 8 знаков после запятой.

Запись появляется только тогда, когда значение медианы изменяется более чем на ε = 1e-8 относительно предыдущего записанного значения.